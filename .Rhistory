sticks <- MACEReports::build_sf_sticks(
x = plot_biomass$lon,
y = plot_biomass$lat,
z = plot_biomass$BIOMASS_NM2,
#group_variable = plot_biomass$size_class,
rotation = rotation,
bar_scale = max_bar_height
)
# get a basemap based around the stick limits
basemap <- MACEReports::get_basemap_layers(plot_limits_data = sticks, plot_expansion = .1, bathy = FALSE, contours = c(100,200,1000))
basemap
# get a legend
stick_legend <- MACEReports::build_stick_legend(stick_data = sticks, legend_color = 'black')
# define a region as a polygon around the the intervals plus a buffer
# and get a zoom-in around the region to limit plots
region_zoom_poly <- intervals_plot %>%
summarize(geometry = st_union(geometry)) %>%
st_convex_hull() %>%
# add a 25 nmi buffer
st_buffer(10 * 1852)
local_plot_labels <- goa_labels[region_zoom_poly,]
# plot it
stickplot <-
basemap +
# add intervals for context
geom_sf(data = intervals_plot, color = 'black', alpha = 0.6) +
# add the sticks
geom_sf(data = sticks, linewidth = 1.0, alpha = 0.5, color = "#0072B2") +
#geom_sf(data = sticks, aes(color = size_class), linewidth = 1.0, alpha = 0.5) +
# add the hauls for context
#geom_sf(data = hauls_plot, color = "#5e3c99", shape = 1, stroke = 2, alpha = 0.5)+
#scale_color_manual(values = c("#0072B2", "#cb181d")) +
guides(
color = guide_legend(
ifelse("AGE" %in% colnames(biomass_data), "Age", "Fork length (cm)"),
nrow = 2,
label.theme = element_text(color = "black", family = "Times"),
title.theme = element_text(color = "black", family = "Times")
),
linetype = guide_legend(override.aes = unit(1, "in")),
fill = "none"
) +
stick_legend +
#add labels, and make sure they don't overlap each other with ggrepel
# ggrepel::geom_label_repel(
#   data = local_plot_labels,
#   aes(label = area_name, geometry = geom),
#   stat = "sf_coordinates",
#   size = 3,
#   family = "Times",
#   fontface = "bold",
#   color = "black",
#   # set the min size for arrows to be made
#   min.segment.length = unit(0.04, "npc"),
#   # Add extra padding around each data point.
#   # point.padding = unit(3, 'lines'),
#   nudge_y = ifelse(local_plot_labels$area_name %in% goa_arrow_list, 1852 * 20, - 1852 * 5),
#   nudge_x = ifelse(local_plot_labels$area_name %in% goa_arrow_list, - 1852 * 10, 0),
#   # Color of the line segments.
#   segment.color = "black",
#   # Width of the line segments.
#   segment.size = 0.4,
#   # Draw an arrow from the label to the data point.
#   arrow = arrow(length = unit(0.01, "npc")),
#   # Strength of the repulsion force.
#   force = 2,
#   label.size = NA,
#   fill = alpha(c("white"), 0.35)
# ) +
# use the standard maps + plots theme; shift legend a bit
theme_bw() +
cruise_report_maps_theme +
cruise_report_plots_theme +
theme(
legend.position = c(0.2, 0.9),
# overwrite a few things in the standard maps/plots- get a white legend box
legend.background = element_rect(fill = "white"),
legend.box.background = element_rect(fill = "white")
)
stickplot
basemap +
# add intervals for context
geom_sf(data = intervals_plot, color = 'black', alpha = 0.6) +
# add the sticks
geom_sf(data = sticks, linewidth = 1.0, alpha = 0.5, color = "#0072B2") +
#geom_sf(data = sticks, aes(color = size_class), linewidth = 1.0, alpha = 0.5) +
# add the hauls for context
#geom_sf(data = hauls_plot, color = "#5e3c99", shape = 1, stroke = 2, alpha = 0.5)+
#scale_color_manual(values = c("#0072B2", "#cb181d")) +
guides(
color = guide_legend(
ifelse("AGE" %in% colnames(biomass_data), "Age", "Fork length (cm)"),
nrow = 2,
label.theme = element_text(color = "black", family = "Times"),
title.theme = element_text(color = "black", family = "Times")
),
linetype = guide_legend(override.aes = unit(1, "in")),
fill = "none"
)
basemap +
# add intervals for context
geom_sf(data = intervals_plot, color = 'black', alpha = 0.6) +
# add the sticks
geom_sf(data = sticks, linewidth = 1.0, alpha = 0.5, color = "#0072B2")
colnames(biomass_data)
basemap +
# add intervals for context
geom_sf(data = intervals_plot, color = 'black', alpha = 0.6) +
# add the sticks
geom_sf(data = sticks, linewidth = 1.0, alpha = 0.5, color = "#0072B2") +
#geom_sf(data = sticks, aes(color = size_class), linewidth = 1.0, alpha = 0.5) +
# add the hauls for context
#geom_sf(data = hauls_plot, color = "#5e3c99", shape = 1, stroke = 2, alpha = 0.5)+
#scale_color_manual(values = c("#0072B2", "#cb181d")) +
guides(
color = guide_legend(
ifelse("AGE" %in% colnames(biomass_data), "Age", "Fork length (cm)"),
nrow = 2,
label.theme = element_text(color = "black", family = "Times"),
title.theme = element_text(color = "black", family = "Times")
),
linetype = guide_legend(override.aes = unit(1, "in")),
fill = "none"
)
guides(
color = guide_legend(
ifelse("AGE" %in% colnames(biomass_data), "Age", "Fork length (cm)"),
nrow = 2,
label.theme = element_text(color = "black", family = "Times"),
title.theme = element_text(color = "black", family = "Times")
),
#linetype = guide_legend(override.aes = unit(1, "in")),
fill = "none"
)
basemap +
# add intervals for context
geom_sf(data = intervals_plot, color = 'black', alpha = 0.6) +
# add the sticks
geom_sf(data = sticks, linewidth = 1.0, alpha = 0.5, color = "#0072B2") +
#geom_sf(data = sticks, aes(color = size_class), linewidth = 1.0, alpha = 0.5) +
# add the hauls for context
#geom_sf(data = hauls_plot, color = "#5e3c99", shape = 1, stroke = 2, alpha = 0.5)+
#scale_color_manual(values = c("#0072B2", "#cb181d")) +
guides(
color = guide_legend(
ifelse("AGE" %in% colnames(biomass_data), "Age", "Fork length (cm)"),
nrow = 2,
label.theme = element_text(color = "black", family = "Times"),
title.theme = element_text(color = "black", family = "Times")
),
#linetype = guide_legend(override.aes = unit(1, "in")),
fill = "none"
)
# plot it
stickplot <-
basemap +
# add intervals for context
geom_sf(data = intervals_plot, color = 'black', alpha = 0.6) +
# add the sticks
geom_sf(data = sticks, linewidth = 1.0, alpha = 0.5, color = "#0072B2") +
#geom_sf(data = sticks, aes(color = size_class), linewidth = 1.0, alpha = 0.5) +
# add the hauls for context
#geom_sf(data = hauls_plot, color = "#5e3c99", shape = 1, stroke = 2, alpha = 0.5)+
#scale_color_manual(values = c("#0072B2", "#cb181d")) +
guides(
color = guide_legend(
ifelse("AGE" %in% colnames(biomass_data), "Age", "Fork length (cm)"),
nrow = 2,
label.theme = element_text(color = "black", family = "Times"),
title.theme = element_text(color = "black", family = "Times")
),
#linetype = guide_legend(override.aes = unit(1, "in")),
fill = "none"
) +
stick_legend +
#add labels, and make sure they don't overlap each other with ggrepel
# ggrepel::geom_label_repel(
#   data = local_plot_labels,
#   aes(label = area_name, geometry = geom),
#   stat = "sf_coordinates",
#   size = 3,
#   family = "Times",
#   fontface = "bold",
#   color = "black",
#   # set the min size for arrows to be made
#   min.segment.length = unit(0.04, "npc"),
#   # Add extra padding around each data point.
#   # point.padding = unit(3, 'lines'),
#   nudge_y = ifelse(local_plot_labels$area_name %in% goa_arrow_list, 1852 * 20, - 1852 * 5),
#   nudge_x = ifelse(local_plot_labels$area_name %in% goa_arrow_list, - 1852 * 10, 0),
#   # Color of the line segments.
#   segment.color = "black",
#   # Width of the line segments.
#   segment.size = 0.4,
#   # Draw an arrow from the label to the data point.
#   arrow = arrow(length = unit(0.01, "npc")),
#   # Strength of the repulsion force.
#   force = 2,
#   label.size = NA,
#   fill = alpha(c("white"), 0.35)
# ) +
# use the standard maps + plots theme; shift legend a bit
theme_bw() +
cruise_report_maps_theme +
cruise_report_plots_theme +
theme(
legend.position = c(0.2, 0.9),
# overwrite a few things in the standard maps/plots- get a white legend box
legend.background = element_rect(fill = "white"),
legend.box.background = element_rect(fill = "white")
)
stickplot
source('scripts/plot_biomass_sticks_function.R')
cap_text <- c()
# check if there is age data; if so make the plot by age, if not, plot by length class
if(age_data == TRUE){
stick_data <- current_survey_biomass_nums_age
#
}
if(age_data != TRUE){
stick_data <- current_year_pollock_biomass_nums
}
current_biomass_sticks <-  plot_biomass_sticks_function(biomass_data = stick_data,
rotation = rotation,
max_bar_height = max_bar_height,
length_class_cutoff = pollock_size_cutoff,
age_class_cutoff = pollock_age_cutoff)
# print the plot
current_biomass_sticks
# build the figure caption- this uses an ifelse statement to make the 'cutoff some bars' text or the 'all bars included' text
cap_text <- paste0("Density (t/nmi^2^) attributed to pollock (vertical lines) along tracklines surveyed during the winter ", current_year, " acoustic-trawl survey of the Bogoslof.")
max_bar_height = 0.5
cap_text <- c()
# check if there is age data; if so make the plot by age, if not, plot by length class
if(age_data == TRUE){
stick_data <- current_survey_biomass_nums_age
#
}
if(age_data != TRUE){
stick_data <- current_year_pollock_biomass_nums
}
current_biomass_sticks <-  plot_biomass_sticks_function(biomass_data = stick_data,
rotation = rotation,
max_bar_height = max_bar_height,
length_class_cutoff = pollock_size_cutoff,
age_class_cutoff = pollock_age_cutoff)
# print the plot
current_biomass_sticks
# build the figure caption- this uses an ifelse statement to make the 'cutoff some bars' text or the 'all bars included' text
cap_text <- paste0("Density (t/nmi^2^) attributed to pollock (vertical lines) along tracklines surveyed during the winter ", current_year, " acoustic-trawl survey of the Bogoslof.")
?theme
# plot it
stickplot <-
basemap +
# add intervals for context
geom_sf(data = intervals_plot, color = 'black', alpha = 0.6) +
# add the sticks
geom_sf(data = sticks, linewidth = 1.0, alpha = 0.5, color = "#0072B2") +
#geom_sf(data = sticks, aes(color = size_class), linewidth = 1.0, alpha = 0.5) +
# add the hauls for context
#geom_sf(data = hauls_plot, color = "#5e3c99", shape = 1, stroke = 2, alpha = 0.5)+
#scale_color_manual(values = c("#0072B2", "#cb181d")) +
guides(
color = guide_legend(
ifelse("AGE" %in% colnames(biomass_data), "Age", "Fork length (cm)"),
nrow = 2,
label.theme = element_text(color = "black", family = "Times"),
title.theme = element_text(color = "black", family = "Times")
),
#linetype = guide_legend(override.aes = unit(1, "in")),
fill = "none"
) +
stick_legend +
#add labels, and make sure they don't overlap each other with ggrepel
# ggrepel::geom_label_repel(
#   data = local_plot_labels,
#   aes(label = area_name, geometry = geom),
#   stat = "sf_coordinates",
#   size = 3,
#   family = "Times",
#   fontface = "bold",
#   color = "black",
#   # set the min size for arrows to be made
#   min.segment.length = unit(0.04, "npc"),
#   # Add extra padding around each data point.
#   # point.padding = unit(3, 'lines'),
#   nudge_y = ifelse(local_plot_labels$area_name %in% goa_arrow_list, 1852 * 20, - 1852 * 5),
#   nudge_x = ifelse(local_plot_labels$area_name %in% goa_arrow_list, - 1852 * 10, 0),
#   # Color of the line segments.
#   segment.color = "black",
#   # Width of the line segments.
#   segment.size = 0.4,
#   # Draw an arrow from the label to the data point.
#   arrow = arrow(length = unit(0.01, "npc")),
#   # Strength of the repulsion force.
#   force = 2,
#   label.size = NA,
#   fill = alpha(c("white"), 0.35)
# ) +
# use the standard maps + plots theme; shift legend a bit
theme_bw() +
cruise_report_maps_theme +
cruise_report_plots_theme +
theme(
legend.position = c(0.2, 0.9),
# overwrite a few things in the standard maps/plots- get a white legend box
legend.background = element_rect(fill = "white"),
legend.box.background = element_rect(fill = "white")
)
stickplot
# plot it
stickplot <-
basemap +
# add intervals for context
geom_sf(data = intervals_plot, color = 'black', alpha = 0.6) +
# add the sticks
geom_sf(data = sticks, linewidth = 1.0, alpha = 0.5, color = "#0072B2") +
#geom_sf(data = sticks, aes(color = size_class), linewidth = 1.0, alpha = 0.5) +
# add the hauls for context
#geom_sf(data = hauls_plot, color = "#5e3c99", shape = 1, stroke = 2, alpha = 0.5)+
#scale_color_manual(values = c("#0072B2", "#cb181d")) +
guides(
color = guide_legend(
ifelse("AGE" %in% colnames(biomass_data), "Age", "Fork length (cm)"),
nrow = 2,
label.theme = element_text(color = "black", family = "Times"),
title.theme = element_text(color = "black", family = "Times")
),
#linetype = guide_legend(override.aes = unit(1, "in")),
fill = "none"
) +
stick_legend +
#add labels, and make sure they don't overlap each other with ggrepel
# ggrepel::geom_label_repel(
#   data = local_plot_labels,
#   aes(label = area_name, geometry = geom),
#   stat = "sf_coordinates",
#   size = 3,
#   family = "Times",
#   fontface = "bold",
#   color = "black",
#   # set the min size for arrows to be made
#   min.segment.length = unit(0.04, "npc"),
#   # Add extra padding around each data point.
#   # point.padding = unit(3, 'lines'),
#   nudge_y = ifelse(local_plot_labels$area_name %in% goa_arrow_list, 1852 * 20, - 1852 * 5),
#   nudge_x = ifelse(local_plot_labels$area_name %in% goa_arrow_list, - 1852 * 10, 0),
#   # Color of the line segments.
#   segment.color = "black",
#   # Width of the line segments.
#   segment.size = 0.4,
#   # Draw an arrow from the label to the data point.
#   arrow = arrow(length = unit(0.01, "npc")),
#   # Strength of the repulsion force.
#   force = 2,
#   label.size = NA,
#   fill = alpha(c("white"), 0.35)
# ) +
# use the standard maps + plots theme; shift legend a bit
theme_bw() +
cruise_report_maps_theme +
cruise_report_plots_theme +
theme(
legend.position = c(0.2, 0.9),
# overwrite a few things in the standard maps/plots- get a white legend box
legend.background = element_rect(fill = "white"),
legend.box.background = element_rect(fill = "red")
)
stickplot
# plot it
stickplot <-
basemap +
# add intervals for context
geom_sf(data = intervals_plot, color = 'black', alpha = 0.6) +
# add the sticks
geom_sf(data = sticks, linewidth = 1.0, alpha = 0.5, color = "#0072B2") +
#geom_sf(data = sticks, aes(color = size_class), linewidth = 1.0, alpha = 0.5) +
# add the hauls for context
#geom_sf(data = hauls_plot, color = "#5e3c99", shape = 1, stroke = 2, alpha = 0.5)+
#scale_color_manual(values = c("#0072B2", "#cb181d")) +
guides(
color = guide_legend(
ifelse("AGE" %in% colnames(biomass_data), "Age", "Fork length (cm)"),
nrow = 2,
label.theme = element_text(color = "black", family = "Times"),
title.theme = element_text(color = "black", family = "Times")
),
#linetype = guide_legend(override.aes = unit(1, "in")),
fill = "none"
) +
stick_legend +
#add labels, and make sure they don't overlap each other with ggrepel
# ggrepel::geom_label_repel(
#   data = local_plot_labels,
#   aes(label = area_name, geometry = geom),
#   stat = "sf_coordinates",
#   size = 3,
#   family = "Times",
#   fontface = "bold",
#   color = "black",
#   # set the min size for arrows to be made
#   min.segment.length = unit(0.04, "npc"),
#   # Add extra padding around each data point.
#   # point.padding = unit(3, 'lines'),
#   nudge_y = ifelse(local_plot_labels$area_name %in% goa_arrow_list, 1852 * 20, - 1852 * 5),
#   nudge_x = ifelse(local_plot_labels$area_name %in% goa_arrow_list, - 1852 * 10, 0),
#   # Color of the line segments.
#   segment.color = "black",
#   # Width of the line segments.
#   segment.size = 0.4,
#   # Draw an arrow from the label to the data point.
#   arrow = arrow(length = unit(0.01, "npc")),
#   # Strength of the repulsion force.
#   force = 2,
#   label.size = NA,
#   fill = alpha(c("white"), 0.35)
# ) +
# use the standard maps + plots theme; shift legend a bit
theme_bw() +
cruise_report_maps_theme +
cruise_report_plots_theme +
theme(
legend.position = c(0.2, 0.9),
# overwrite a few things in the standard maps/plots- get a white legend box
legend.background = element_rect(fill = "red"),
legend.box.background = element_rect(fill = "white")
)
stickplot
# plot it
stickplot <-
basemap +
# add intervals for context
geom_sf(data = intervals_plot, color = 'black', alpha = 0.6) +
# add the sticks
geom_sf(data = sticks, linewidth = 1.0, alpha = 0.5, color = "#0072B2") +
#geom_sf(data = sticks, aes(color = size_class), linewidth = 1.0, alpha = 0.5) +
# add the hauls for context
#geom_sf(data = hauls_plot, color = "#5e3c99", shape = 1, stroke = 2, alpha = 0.5)+
#scale_color_manual(values = c("#0072B2", "#cb181d")) +
guides(
color = guide_legend(
ifelse("AGE" %in% colnames(biomass_data), "Age", "Fork length (cm)"),
nrow = 2,
label.theme = element_text(color = "black", family = "Times"),
title.theme = element_text(color = "black", family = "Times")
),
#linetype = guide_legend(override.aes = unit(1, "in")),
fill = "none"
) +
stick_legend +
#add labels, and make sure they don't overlap each other with ggrepel
# ggrepel::geom_label_repel(
#   data = local_plot_labels,
#   aes(label = area_name, geometry = geom),
#   stat = "sf_coordinates",
#   size = 3,
#   family = "Times",
#   fontface = "bold",
#   color = "black",
#   # set the min size for arrows to be made
#   min.segment.length = unit(0.04, "npc"),
#   # Add extra padding around each data point.
#   # point.padding = unit(3, 'lines'),
#   nudge_y = ifelse(local_plot_labels$area_name %in% goa_arrow_list, 1852 * 20, - 1852 * 5),
#   nudge_x = ifelse(local_plot_labels$area_name %in% goa_arrow_list, - 1852 * 10, 0),
#   # Color of the line segments.
#   segment.color = "black",
#   # Width of the line segments.
#   segment.size = 0.4,
#   # Draw an arrow from the label to the data point.
#   arrow = arrow(length = unit(0.01, "npc")),
#   # Strength of the repulsion force.
#   force = 2,
#   label.size = NA,
#   fill = alpha(c("white"), 0.35)
# ) +
# use the standard maps + plots theme; shift legend a bit
theme_bw() +
#cruise_report_maps_theme +
#cruise_report_plots_theme +
theme(
legend.position = c(0.2, 0.9),
# overwrite a few things in the standard maps/plots- get a white legend box
legend.background = element_rect(fill = "white"),
legend.box.background = element_rect(fill = "white")
)
stickplot
class(stick_legend)
View(stick_legend)
8*.66
4/3
16/9
6 * (4/3)
5 * (4/3)
5 * (16/9)
# start with a blank figure caption; add one if there's a survey
cap_text <- c()
# NATE if you want the failed haul, just set scaling_hauls_only = FALSE
intervals_hauls_map <- plot_intervals_hauls_map_function(gear_type_options = mace_gear_types, add_haul_numbers = FALSE, scaling_hauls_only = TRUE)
print(intervals_hauls_map)
# build the figure caption
cap_text <- paste0("Transect lines and trawl haul locations during the ", current_year, " winter pre-spawning acoustic-trawl surveys. The survey region associated with each transect is indicated by the transect color. The location of trawl events are indicated with purple markers. NMFS reporting areas are noted in white text. Bottom depths are indicated in greyscale. Note that this scale is used in all maps throughout report.")
# start with a blank figure caption; add one if there's a survey
cap_text <- c()
# NATE if you want the failed haul, just set scaling_hauls_only = FALSE
intervals_hauls_map <- plot_intervals_hauls_map_function(gear_type_options = mace_gear_types, add_haul_numbers = FALSE, scaling_hauls_only = TRUE)
print(intervals_hauls_map)
# build the figure caption
cap_text <- paste0("Transect lines and trawl haul locations during the ", current_year, " winter pre-spawning acoustic-trawl surveys. The survey region associated with each transect is indicated by the transect color. The location of trawl events are indicated with purple markers. NMFS reporting areas are noted in white text. Bottom depths are indicated in greyscale. Note that this scale is used in all maps throughout report.")
# check for the file path- make it if it doesn't exist
test_path <- "stock_assessment_output/"
dir.exists(test_path)
