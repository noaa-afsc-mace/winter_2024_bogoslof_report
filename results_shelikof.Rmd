
```{r echo = FALSE, message=FALSE, warning=FALSE}
# identify the requested report region
region_id <- "Shelikof Strait"

# subset the region of interest from intervals
region_interval_data <- current_year_interval_data %>%
  filter(region == region_id)

# subset the events in the region of interest- events
region_event_data <- current_year_event_data %>%
  filter(region == region_id)

# subset the specimen table data-
region_specimen_data <- specimen_table_data %>%
  filter(region == region_id)

# and the catch table....
# subset the specimen table data-
region_catch_data <- catch_table_data %>%
  filter(region == region_id)

# use the subset of haul data to make sure you are ONLY getting maturity data fof the shelikof.
maturities_and_weights <- maturities_and_weights %>%
  filter(region == region_id) 

# identify the survey years
# survey year is grabbed from the 'common values' on the main script
# get the value for the previous survey year- this should work in cases where we skip a year as it just
# sorts all survey years and finds the next in line
survey_years <- -desc(sort(unique(all_species_biomass_nums$year
[all_species_biomass_nums$region == region_id])))
last_year <- survey_years[length(survey_years) - 1]


### Basic survey info: region name, survey dates, total area surveyed, min/max depth, total trackline.
# format start date/end date as Day Month, i.e. '4 June'
start_date <- paste(
  lubridate::day(min(region_interval_data$START_TIME)),
  lubridate::month(min(region_interval_data$START_TIME), label = TRUE, abbr = FALSE)
)


end_date <- paste(
  lubridate::day(max(region_interval_data$START_TIME)),
  lubridate::month(max(region_interval_data$START_TIME), label = TRUE, abbr = FALSE)
)

# get the total area surveyed as sum(interval_length * interval_width); set all intervals as 0.5 nmi length
# as this is what's used in calcs
# report totals in nmi2 and km2
total_survey_area_nmi2 <- sum(0.5 * region_interval_data$INTERVAL_WIDTH, na.rm = TRUE)
total_survey_area_km2 <- sum((0.5 * 1.852) * (region_interval_data$INTERVAL_WIDTH * 1.852), na.rm = TRUE)

# get total transect length/width by report number; use Mode function to report the most common spacing
transect_stats <- region_interval_data %>%
  group_by(REPORT_NUMBER, region) %>%
  summarize(
    transect_length_nmi = sum(LENGTH),
    transect_length_km = sum(LENGTH) * 1.852,
    min_bot_depth = min(MEAN_BOTTOM_DEPTH, na.rm = TRUE),
    max_bot_depth = max(MEAN_BOTTOM_DEPTH, na.rm = TRUE),
    min_spacing_nmi = min(INTERVAL_WIDTH, na.rm = TRUE),
    min_spacing_km = min(INTERVAL_WIDTH, na.rm = TRUE) * 1.852,
    max_spacing_nmi = max(INTERVAL_WIDTH, na.rm = TRUE),
    max_spacing_km = max(INTERVAL_WIDTH, na.rm = TRUE) * 1.852,
    primary_spacing_nmi = Mode(INTERVAL_WIDTH),
    primary_spacing_km = Mode(INTERVAL_WIDTH) * 1.852
  )
```

## `r region_id `

*Survey timing and extent*

The `r current_year` winter AT survey of pre-spawning pollock in `r region_id` was conducted between `r start_date` and `r end_date`. The entire survey area encompassed `r  print_n_decimal(total_survey_area_km2, 0)` km^2^ (`r print_n_decimal(total_survey_area_nmi2, 0)` nmi^2^). Acoustic backscatter was measured along `r print_n_decimal(transect_stats$transect_length_km, 1)` km (`r print_n_decimal(transect_stats$transect_length_nmi, 1) ` nmi) of transects spaced mainly `r round(transect_stats$primary_spacing_km, digits = 1) ` km (`r round(transect_stats$primary_spacing_nmi, digits = 1) ` nmi) apart, with spacing varying from `r round(transect_stats$min_spacing_km, digits = 1) ` km to `r round(transect_stats$max_spacing_km, digits = 1) ` km (`r round(transect_stats$min_spacing_nmi, digits = 1)` to `r round(transect_stats$max_spacing_nmi, digits = 1)` nmi) in the survey area (Fig. \@ref(fig:surveylocationmap)). Bottom depths in the survey area ranged from `r round(transect_stats$min_bot_depth, digits=0) ` m to `r round(transect_stats$max_bot_depth, digits=0) ` m. 

*Environmental conditions*

```{r echo = FALSE, message=FALSE, warning=FALSE}
#### Pull out the SST data for the region of interest.....

# compare sea surface temps at fishing locations to the historical sea surface temps- these values are returned
# from the function 'plot_historical_sst_at_fishing_locs' as:
# list item 2: historical mean

region_sst <- plot_historical_sst_anomalies(
  historical_sst_loc = historical_trawl_sst,
  historical_sst_scs = historical_scs_sst,
  region = "Shelikof Strait"
)

annual_mean_sst <- region_sst[[2]]

# pull the historical mean, and last year's value, from here
mean_sst_loc_1980_lstyr <- mean(annual_mean_sst$mean_sst_loc[annual_mean_sst$year != current_year], na.rm = TRUE)
mean_sst_loc_2006_lstyr <- mean(annual_mean_sst$mean_sst_loc[annual_mean_sst$year %in% c(2006:last_year)], na.rm = TRUE)
mean_sst_scs_2006_lstyr <- mean(annual_mean_sst$mean_sst_scs[annual_mean_sst$year %in% c(2006:last_year)], na.rm = TRUE)
last_year_mean_sst_loc <- mean(annual_mean_sst$mean_sst_loc[annual_mean_sst$year == last_year])
last_year_mean_sst_scs <- mean(annual_mean_sst$mean_sst_scs[annual_mean_sst$year == last_year])
survey_year_mean_sst_loc <- mean(annual_mean_sst$mean_sst_loc[annual_mean_sst$year == current_year])
survey_year_mean_sst_scs <- mean(annual_mean_sst$mean_sst_scs[annual_mean_sst$year == current_year])

# characterize current survey year conditions relative to historical SCS SST mean
survey_year_conditions <- "average"
if (annual_mean_sst$sst_scs_anomaly[annual_mean_sst$year == current_year] >= abs(0.5)) {
  survey_year_conditions <- ifelse(annual_mean_sst$sst_scs_anomaly[annual_mean_sst$year == current_year] >= 0.5, "warmer", "cooler")
}


### SBE profiles by pollock size class
# get the surface/gear temps for the requested region from the hauls data table
gear_table_for_region <- haul_table_data %>%
  filter(region == region_id)

stemp <- NULL
stemp_sd <- NULL
gtemp <- NULL
gtemp_sd <- NULL
tdiff <- NULL

# If stats for a single set of all SBE profiles is presented
if (SBE_Nset == 1) {
  stemp <- list(mean(gear_table_for_region$SURFACE_TEMP, na.rm = TRUE))
  gtemp <- list(mean(gear_table_for_region$HEAD_ROPE_TEMP, na.rm = TRUE))
  tdiff <- list(mean(gear_table_for_region$SURFACE_TEMP, na.rm = TRUE) - mean(gear_table_for_region$HEAD_ROPE_TEMP, na.rm = TRUE))
}
# If stats for multiple sets of SBE profiles are presented
if (SBE_Nset >= 2) {
  for (s in 1:SBE_Nset) {
    stemp[s] <- list(mean(gear_table_for_region$SURFACE_TEMP[gear_table_for_region$EVENT_ID %in% SBE_set.ls[[s]]], na.rm = TRUE))
    stemp_sd[s] <- list(sd(gear_table_for_region$SURFACE_TEMP[gear_table_for_region$EVENT_ID %in% SBE_set.ls[[s]]], na.rm = TRUE))
    gtemp[s] <- list(mean(gear_table_for_region$HEAD_ROPE_TEMP[gear_table_for_region$EVENT_ID %in% SBE_set.ls[[s]]], na.rm = TRUE))
    gtemp_sd[s] <- list(sd(gear_table_for_region$HEAD_ROPE_TEMP[gear_table_for_region$EVENT_ID %in% SBE_set.ls[[s]]], na.rm = TRUE))
    tdiff[s] <- list(stemp[[s]] - gtemp[[s]])
  }
}

shel_scs_summary <- scs_summary %>%
  filter(region == region_id)


```

Sea surface temperatures (SST) measured in Shelikof Strait `r current_year` indicate relatively `r survey_year_conditions` thermal conditions during the survey. SST ranged from `r round(shel_scs_summary$min_temp, digits=1)`°C to `r round(shel_scs_summary$max_temp, digits=1)`°C as measured by the ship's flow-through instrumentation along acoustic transects and averaged `r round(shel_scs_summary$mean_temp, digits =1)`°C (Fig. \@ref(fig:shelikofSST)). The along-transect mean SST was `r ifelse(round(abs(survey_year_mean_sst_scs - last_year_mean_sst_scs), digits = 1)>0, paste0(round(abs(survey_year_mean_sst_scs - last_year_mean_sst_scs), digits = 1),'°C ',ifelse(survey_year_mean_sst_scs > last_year_mean_sst_scs, 'warmer than', 'cooler than')), 'the same as')` observed during `r last_year` and `r round(abs(survey_year_mean_sst_scs - mean_sst_scs_2006_lstyr), digits = 1)`°C `r ifelse(survey_year_mean_sst_scs >= mean_sst_scs_2006_lstyr, "warmer", "cooler")` than the 2006–`r last_year` historical mean (`r print_n_decimal(mean_sst_scs_2006_lstyr, 1)`°C). The average SST measured by the SBE 39 at all haul locations was `r round(survey_year_mean_sst_loc, digits =1)`°C (Table \@ref(tab:surveyhaultable)), which was `r round(abs(survey_year_mean_sst_loc - last_year_mean_sst_loc), digits = 1)`°C `r ifelse(survey_year_mean_sst_loc >= last_year_mean_sst_loc, "warmer", "cooler")` than the haul-based mean SST in `r last_year`, `r round(abs(survey_year_mean_sst_loc - mean_sst_loc_2006_lstyr), digits = 1)`°C `r ifelse(survey_year_mean_sst_loc >= mean_sst_loc_2006_lstyr, "warmer", "cooler")` than the 2006–`r last_year` historical mean, and `r round(abs(survey_year_mean_sst_loc - mean_sst_loc_1980_lstyr), digits = 1)`°C `r ifelse(survey_year_mean_sst_loc >= mean_sst_loc_1980_lstyr, "warmer", "cooler")` than the long-term 1980–`r last_year` historical mean. Mean SST anomalies from both sources in `r current_year` were less than ± 0.5°C, indicating average conditions relative to the 2006–`r last_year` period (Fig. \@ref(fig:shelikofstraitsstfishingloc)). Mean temperature between the surface and deepest trawl (i.e. headrope) depth at all haul locations varied by approximately `r abs(round(mean(gear_table_for_region$SURFACE_TEMP, na.rm = TRUE) - mean(gear_table_for_region$HEAD_ROPE_TEMP, na.rm = TRUE), digits=1))`°C (Fig. \@ref(fig:shelikofstraitsbe)).

*Trawl Catch Summary*

```{r echo = FALSE, message=FALSE, warning=FALSE}
# get all the gear types, and build a list that separates them by commas or 'and' as needed
gear_names <- unique(as.character(region_event_data$"Gear type"))

gear_counts <- list()

for (i in 1:length(gear_names)) {
  gear_counts[i] <- sum((region_event_data$"Gear type" == gear_names[i]), na.rm = TRUE)
}

# get the counts of different haul types for the text
gearboth <- paste0(gear_counts, (paste0(" ", gear_names)))
gearboth <- knitr::combine_words(gearboth)

# query out counts of fork length measurements and ages for the different hauls...
# this information has already been gathered for the 's_specimen_table_data' dataset;
# we'll add the gear information to this dataset
specimen_text_data <- left_join(region_specimen_data,
  st_drop_geometry(region_event_data),
  by = c("SURVEY", "HAUL" = "EVENT_ID", "region")
)


if (survey_shelikof == 202003) {
  # just for 2020, only LFS counts were used for specimen data.
  specimen_region_summary <- specimen_text_data %>%
    rename(gear_type = "Gear type") %>%
    filter(gear_type == "LFS1421") %>%
    summarize(
      n_lengths = mean(CATCH_LENGTHS, na.rm = TRUE),
      n_weights = mean(WEIGHTS, na.rm = TRUE),
      n_maturities = mean(MATURITIES, na.rm = TRUE),
      n_ages = mean(OTOLITHS, na.rm = TRUE),
      n_all = mean(c(WEIGHTS, MATURITIES, OTOLITHS, OVARY_WEIGHTS), na.rm = TRUE),
      n_hauls = n()
    )
} else {
  # For other years all fish-containing hauls are used
  specimen_region_summary <- specimen_text_data %>%
    rename(gear_type = "Gear type") %>%
    summarize(
      n_lengths = mean(CATCH_LENGTHS, na.rm = TRUE),
      n_weights = mean(WEIGHTS, na.rm = TRUE),
      n_maturities = mean(MATURITIES, na.rm = TRUE),
      n_ages = mean(OTOLITHS, na.rm = TRUE),
      n_all = mean(c(WEIGHTS, MATURITIES, OTOLITHS, OVARY_WEIGHTS), na.rm = TRUE),
      n_hauls = n()
    )
}

# Catch summary by gear by weight
catchbyarea_LFS <- region_catch_data %>%
  # report LFS hauls only from requested region
  filter(GEAR == "LFS1421") %>%
  group_by(GEAR) %>%
  # make sure table is ordered by weight for reporting in text
  arrange(desc(TOT_WEIGHT)) %>%
  # get 'nice' names to print
  mutate(COMMON_NAME = map_chr(COMMON_NAME, print_species_name))

# Catch summary by gear by number
catchbyarea2_LFS <- region_catch_data %>%
  # report LFS hauls only from requested region
  filter(GEAR == "LFS1421") %>%
  group_by(GEAR) %>%
  # make sure table is ordered by weight for reporting in text
  arrange(desc(TOT_NUMBER)) %>%
  # get 'nice' names to print
  mutate(COMMON_NAME = map_chr(COMMON_NAME, print_species_name))

# If any PNEs were conducted, build a summary of top two items
if (any(region_catch_data$GEAR == "PNE")) {
  catchbyarea_PNE <- region_catch_data %>%
    # report LFS hauls only from requested region
    filter(GEAR == "PNE") %>%
    group_by(GEAR) %>%
    # make sure table is ordered by weight for reporting in text
    arrange(desc(TOT_WEIGHT)) %>%
    # get 'nice' names to print
    mutate(COMMON_NAME = map_chr(COMMON_NAME, print_species_name))

  # build the PNE statement
  pne_statement <- paste(.simpleCap(catchbyarea_PNE$COMMON_NAME[1]), "and", catchbyarea_PNE$COMMON_NAME[2], ifelse((catchbyarea_PNE$COMMON_NAME[1] == catchbyarea_LFS$COMMON_NAME[1] & catchbyarea_PNE$COMMON_NAME[2] == catchbyarea_LFS$COMMON_NAME[2]), "were also", "were"), "the most abundant species in the PNE", ifelse(gear_counts[[2]][1] > 1, "hauls", "haul"), "contributing", round(catchbyarea_PNE$TOT_WEIGHT[1] / sum(catchbyarea_PNE$TOT_WEIGHT) * 100, digits = 1), "% and", round(catchbyarea_PNE$TOT_WEIGHT[2] / sum(catchbyarea_PNE$TOT_WEIGHT) * 100, digits = 1), "% of the total catch by weight and", round(catchbyarea_PNE$TOT_NUMBER[1] / sum(catchbyarea_PNE$TOT_NUMBER) * 100, digits = 1), "% and", round(catchbyarea_PNE$TOT_NUMBER[2] / sum(catchbyarea_PNE$TOT_NUMBER) * 100, digits = 1), "% of the total catch by numbers, respectively (Table \\@ref(tab:shelikofstraitpne)).")
}

# if there were no PNEs, print nothing
if (!any(region_catch_data$GEAR == "PNE")) {
  pne_statement <- c()
}
```

Biological data and specimens were collected in `r region_id` from `r gearboth ` hauls (Table \@ref(tab:surveyhaultable), Fig. \@ref(fig:surveylocationmap)) targeted on backscatter attributed to pollock. The lengths of an average of `r round(specimen_region_summary$n_lengths, digits = 0) `  randomly selected pollock were measured from each haul, with an average of `r round(specimen_region_summary$n_ages, digits = 0) ` individuals more extensively sampled for at least one of the following: body weight, maturity, and age (Table \@ref(tab:surveyspecimen)). A total of `r sum(specimen_text_data$OTOLITHS, na.rm = TRUE) ` otoliths used to estimate pollock ages were collected in the `r region_id` region (Table \@ref(tab:surveyspecimen)). 

 `r .simpleCap(catchbyarea_LFS$COMMON_NAME[1])` and `r catchbyarea_LFS$COMMON_NAME[2]` were the most abundant species by weight in the LFS1421 hauls, contributing `r round(catchbyarea_LFS$TOT_WEIGHT[1]/sum(catchbyarea_LFS$TOT_WEIGHT)*100, digits = 1)`% and `r round(catchbyarea_LFS$TOT_WEIGHT[2]/sum(catchbyarea_LFS$TOT_WEIGHT)*100, digits = 1)`% of the total catch by weight respectively (Table \@ref(tab:shelikofstraitlfs1421)). `r .simpleCap(catchbyarea2_LFS$COMMON_NAME[1])` and `r catchbyarea2_LFS$COMMON_NAME[2]`  were the most abundant species by numbers with `r round(catchbyarea2_LFS$TOT_NUMBER[1]/sum(catchbyarea2_LFS$TOT_NUMBER)*100, digits = 1)`% and `r round(catchbyarea2_LFS$TOT_NUMBER[2]/sum(catchbyarea2_LFS$TOT_NUMBER)*100, digits = 1)`% of the total catch by numbers, respectively (Table \@ref(tab:shelikofstraitlfs1421)). `r pne_statement`

*Pollock Maturity*

```{r echo = FALSE, message=FALSE, warning=FALSE}
# maturity data

# historical GSI- location for each survey .csv file
# shelikof_historical_trawl_weights =  'historical_data/shelikof_survey_weights_cutoff_30_cm.csv'
# shelikof_historical_GSI= 'historical_data/shelikof_survey_weighted_GSI_cutoff_30_cm.csv'

# the function that makes plots for the figs/tables should return all the needed values here- using region_id here....
maturity_data <- plot_abundance_weighted_maturity(ship = ship_shelikof, 
                                                  survey = survey_shelikof,  
                                                  region_id = "Shelikof Strait")

# get the counts at each stage
maturity_summary_stage <- maturity_data[[2]]

# replace "Prespawning" with "pre-spawning" to match text in report
levels(maturity_summary_stage$MATURITY)[levels(maturity_summary_stage$MATURITY) == "Prespawning"] <- "pre-spawning"

# identify most common stages
maturities_male <- maturity_summary_stage[maturity_summary_stage$SEX == "Male", ]
maturities_female <- maturity_summary_stage[maturity_summary_stage$SEX == "Female", ]

most_common_male <- maturities_male$MATURITY[which.max(maturities_male$wt_percent)]
most_common_female <- maturities_female$MATURITY[which.max(maturities_female$wt_percent)]

# get the sample sizes
maturity_nums <- maturity_data[[5]]

# get the L50
L50_val <- maturity_data[[1]]$L50

# and the GSI stats
GSI_stats <- maturity_data[[3]]

# and the minimum fork length used in L50 calcs
min_L50_length <- min(prop_mature$FORK_LENGTH[prop_mature$region == region_id])
```
 
Most female pollock in `r region_id` were in the `r tolower(most_common_female)` stage of maturity and substantially fewer were spawning or spent, which suggests that the timing of the `r current_year ` `r region_id` survey relative to the spawning period was appropriate. The maturity composition of females > 40 cm FL (n = `r maturity_nums$n[maturity_nums$SEX == 'Female']`) was `r round(maturity_summary_stage$wt_percent[maturity_summary_stage$SEX == 'Female' & maturity_summary_stage$MATURITY == 'Immature'], digits = 0)`% immature, `r round(maturity_summary_stage$wt_percent[maturity_summary_stage$SEX == 'Female' & maturity_summary_stage$MATURITY == 'Developing'], digits = 0)`% developing, `r round(maturity_summary_stage$wt_percent[maturity_summary_stage$SEX == 'Female' & maturity_summary_stage$MATURITY == 'pre-spawning'], digits = 0)`% pre-spawning, `r round(maturity_summary_stage$wt_percent[maturity_summary_stage$SEX == 'Female' & maturity_summary_stage$MATURITY == 'Spawning'], digits = 0)`% spawning, and `r round(maturity_summary_stage$wt_percent[maturity_summary_stage$SEX == 'Female' & maturity_summary_stage$MATURITY == 'Spent'], digits = 0)`% spent, while the maturity composition of males > 40 cm FL (n = `r maturity_nums$n[maturity_nums$SEX == 'Male']`) was `r round(maturity_summary_stage$wt_percent[maturity_summary_stage$SEX == 'Male' & maturity_summary_stage$MATURITY == 'Immature'], digits = 0)`% immature, `r round(maturity_summary_stage$wt_percent[maturity_summary_stage$SEX == 'Male' & maturity_summary_stage$MATURITY == 'Developing'], digits = 0)`% developing, `r round(maturity_summary_stage$wt_percent[maturity_summary_stage$SEX == 'Male' & maturity_summary_stage$MATURITY == 'pre-spawning'], digits = 0)`% pre-spawning, `r round(maturity_summary_stage$wt_percent[maturity_summary_stage$SEX == 'Male' & maturity_summary_stage$MATURITY == 'Spawning'], digits = 0)`% spawning, and `r round(maturity_summary_stage$wt_percent[maturity_summary_stage$SEX == 'Male' & maturity_summary_stage$MATURITY == 'Spent'], digits = 0)`% spent (Fig. \@ref(fig:shelikofstraitmaturity)a). The length at which 50% of female pollock were determined to be reproductively mature (i.e., pre-spawning, spawning, or spent) is `r L50_val ` cm FL (Fig. \@ref(fig:shelikofstraitmaturity)b). The average GSI from  `r GSI_stats$n_gsi_females` pre-spawning females was `r round(GSI_stats$mean_weighted_GSI, digits =2) `  $\pm$ `r round(GSI_stats$std_weighted_GSI, digits =2) ` (Fig. \@ref(fig:shelikofstraitmaturity)c, mean $\pm$ standard deviation), which was within 1 standard deviation of the `r current_year - 1` estimate (0.14 $\pm$ 0.02) and the historical mean (`r round(GSI_stats$wtd_mean_without_current_survey, digits=2) ` $\pm$ `r round(GSI_stats$wtd_std_without_current_survey, digits =2) `). 

*Distribution and Abundance*

```{r echo = FALSE, message=FALSE, warning=FALSE}
# get the numbers at length by report number
num_bio_at_length_summary <- current_year_pollock_biomass_nums %>%
  # for this report- make sure we're only reporting the requested region
  filter(region == region_id) %>%
  group_by(REPORT_NUMBER, region, LENGTH) %>%
  summarize(
    num_individuals = sum(NUMBERS),
    biomass_kg = sum(BIOMASS)
  ) %>%
  # also report proportions at each length
  mutate(
    numprop = num_individuals / sum(num_individuals),
    bioprop = biomass_kg / sum(biomass_kg)
  )

# summarize by adult (> 30 cm FL) and juvenile (<= 30 cm FL) sized pollock
adultfish <- num_bio_at_length_summary %>%
  filter(LENGTH > 30)
adultfishnumpct <- (sum(adultfish$numprop)) * 100
adultfishbiopct <- (sum(adultfish$bioprop)) * 100

juvfish <- num_bio_at_length_summary %>%
  filter(LENGTH <= 30)
juvfishnumpct <- (sum(juvfish$numprop)) * 100
juvfishbiopct <- (sum(juvfish$bioprop)) * 100

# talk about AGES here- not lengths- if we have ages.
if (isTRUE(age_data)) {
  num_bio_at_age_summary <- shelikof_current_survey_biomass_nums_age %>%
    # for this report- make sure we're only reporting the requested region
    filter(region == region_id) %>%
    group_by(REPORT_NUMBER, region, AGE) %>%
    summarize(
      num_individuals = sum(NUMBERS),
      biomass_kg = sum(BIOMASS)
    ) %>%
    # also report proportions at each length
    mutate(
      numprop = num_individuals / sum(num_individuals),
      bioprop = biomass_kg / sum(biomass_kg)
    )


  age1fish <- num_bio_at_age_summary %>%
    filter(AGE == 1)

  age1numpct <- (sum(age1fish$numprop)) * 100
  age1biopct <- (sum(age1fish$bioprop)) * 100

  # is this right?????- Taina thinks no....
  age2fish <- num_bio_at_age_summary %>%
    filter(AGE == 2)

  age2numpct <- (sum(age2fish$numprop)) * 100
  age2biopct <- (sum(age2fish$bioprop)) * 100
  
  age3fish <- num_bio_at_age_summary %>%
    filter(AGE == 3)

  age3numpct <- (sum(age3fish$numprop)) * 100
  age3biopct <- (sum(age3fish$bioprop)) * 100

  age3plusfish <- num_bio_at_age_summary %>%
    filter(AGE >= 3)

  age3plusnumpct <- (sum(age3plusfish$numprop)) * 100
  age3plusbiopct <- (sum(age3plusfish$bioprop)) * 100

  age4plusfish <- num_bio_at_age_summary %>%
    filter(AGE >= 4)

  age4plusnumpct <- (sum(age4plusfish$numprop)) * 100
  age4plusbiopct <- (sum(age4plusfish$bioprop)) * 100

  # select estimates for specific year classes of interest
  yr2018fish <- num_bio_at_age_summary %>%
    filter(AGE == current_year - 2018)

  yr2018fishnumpct <- (sum(yr2018fish$numprop)) * 100
  yr2018fishbiopct <- (sum(yr2018fish$bioprop)) * 100

  yr2017fish <- num_bio_at_age_summary %>%
    filter(AGE == current_year - 2017)

  yr2017fishnumpct <- (sum(yr2017fish$numprop)) * 100
  yr2017fishbiopct <- (sum(yr2017fish$bioprop)) * 100

  yr2012fish <- num_bio_at_age_summary %>%
    filter(AGE == current_year - 2012)

  yr2012fishnumpct <- (sum(yr2012fish$numprop)) * 100
  yr2012fishbiopct <- (sum(yr2012fish$bioprop)) * 100
}

# and overall
rawbio <- sum(num_bio_at_length_summary$biomass_kg)
rawnum <- sum(num_bio_at_length_summary$num_individuals)

# compare to last year's biomass/nums
last_year_vals <- sel_corr_surveys_pollock_totals_by_length %>%
  # for this report- make sure we're only reporting the requested region
  filter(region == region_id & year == last_year) %>%
  group_by(year) %>%
  summarize(
    num_individuals = sum(NUMBERS),
    biomass_kg = sum(BIOMASS)
  )

# and get the current survey as a percent of last year biomass
# pctoflastyr=((last_year_vals$biomass_kg-rawbio)/last_year_vals$biomass_kg)*100
biomass_change_from_last_year <- (rawbio - last_year_vals$biomass_kg) / last_year_vals$biomass_kg * 100

meanHistBiomass <- calculate_mean_historical_biomass_function(pre_sel_corr_data_path = pre_selectivity_biomass_nums_ages_path, post_sel_corr_data = sel_corr_surveys_pollock_totals_by_length, region_id = region_id)

# calculate the percent of the historic biomass
pctofhistoric <- (rawbio / 1e6) / meanHistBiomass * 100

# or, as a % change from historic (in this case 48% decline from historic)
# pctofhistoric = ((rawbio/1e6)- meanHistBiomass)/meanHistBiomass * 100

# if you don't have ages just add an NA for now
if (!isTRUE(age_data)) {
  age1numpct <- NA
  age1biopct <- NA
  age2numpct <- NA
  age2biopct <- NA
  age3fishnumpct <- NA
  age3fishbiopct <- NA
  age3plusnumpct <- NA
  age3plusbiopct <- NA
  age4plusnumpct <- NA
  age4plusbiopct <- NA
  yr2012fishbiopct <- NA
  yr2017fishbiopct <- NA
  yr2018fishbiopct <- NA
}
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
# load geostat model outputs generated in 'plot_interpolated_survey_comparisons_winter_function.R' script & create objects for historical (2008-2021), prior year, & current year eastings & northings

plot_cog <- readRDS("geostat_outputs/COG_point_estimates.rds") # object 'plot_cog'
#test <- readRDS("geostat_outputs/Inertia_axes_estimates.rds") # object 'plot_axes'
historical_COG_eastings <- mean(plot_cog$Eastings[plot_cog$Year != current_year] / 1000, na.rm = T)
historical_COG_northings <- mean(plot_cog$Northings[plot_cog$Year != current_year] / 1000, na.rm = T)
last_year_COG_eastings <- plot_cog$Eastings[plot_cog$Year == last_year] / 1000
last_year_COG_northings <- plot_cog$Northings[plot_cog$Year == last_year] / 1000
surv_year_COG_eastings <- plot_cog$Eastings[plot_cog$Year == current_year] / 1000
surv_year_COG_northings <- plot_cog$Northings[plot_cog$Year == current_year] / 1000

# for the bottom-referenced data, report depths as heights and then calculate the total biomass/nums within each layer
if (!is.null(vertical_dist_bot_ref_biomass_nums_by_length)) {
  bottom_referenced_summary <- vertical_dist_bot_ref_biomass_nums_by_length %>%
    # limit things to the shelikof survey
    filter(region == region_id & SPECIES_CODE == 21740) %>%
    # report height (i.e. inverse of depth) of upper ref line, this will set bottom bin @ o (seafloor);
    # label observations by size class and year
    mutate(
      height = -depth,
      size_class = ifelse(LENGTH <= pollock_size_cutoff, "juvenile_layer_biomass", "adult_layer_biomass")
    )

  # for the surface-referenced data, calculate the total biomass/nums within each layer
  surface_referenced_summary <- vertical_dist_surf_ref_biomass_nums_by_length %>%
    # limit things to the shelikof survey
    filter(region == region_id & SPECIES_CODE == 21740) %>%
    # report depth as the range from upper reference to be consistent;
    # label observations by size class and year
    mutate(size_class = ifelse(LENGTH <= pollock_size_cutoff, "juvenile_layer_biomass", "adult_layer_biomass"))

  # pull out a few stats to report: mwd, ranges pollock observed at, etc

  # report the mwd for each dataset
  mwd_bottom_ref <- bottom_referenced_summary %>%
    # sum biomass/numbers in each layer/size class
    group_by(year, height, size_class) %>%
    summarize(
      layer_biomass = sum(BIOMASS),
      layer_nums = sum(NUMBERS)
    ) %>%
    # get the mean weighted depth for each size class
    group_by(year, size_class) %>%
    summarize(mwd = sum(height * layer_biomass) / sum(layer_biomass)) %>%
    mutate(ref = "bottom")

  mwd_surf_ref <- surface_referenced_summary %>%
    group_by(year, depth, size_class) %>%
    summarize(
      layer_biomass = sum(BIOMASS),
      layer_nums = sum(NUMBERS)
    ) %>%
    group_by(year, size_class) %>%
    summarize(mwd = sum((layer_biomass / sum(layer_biomass)) * depth)) %>%
    mutate(ref = "surface")


  # what were the predominant pollock depths for adults?
  # we'll take this as the middle 50% of the distribution from the surface, i.e. the inter-quartile range
  most_common_depth <- surface_referenced_summary %>%
    group_by(year, depth, size_class) %>%
    # sum biomass/numbers in each layer/size class
    summarize(
      layer_biomass = sum(BIOMASS),
      layer_nums = sum(NUMBERS)
    ) %>%
    # to be safe, arrange by depth
    arrange(depth)


  # and calculate the adult 75% depth quantile (0.125- 0.875 of biomass) weighted by biomass
  adult_common_depths <- most_common_depth[most_common_depth$size_class == "adult_layer_biomass" &
    most_common_depth$year == current_year, ]

  adult_common_depths <- Hmisc::wtd.quantile(adult_common_depths$depth,
    weights = adult_common_depths$layer_biomass,
    probs = c(0.125, 0.875)
  )


  # and calculate the juveline 75% depth quantile (0.125- 0.875 of biomass) weighted by biomass
  juvenile_common_depths <- most_common_depth[most_common_depth$size_class == "juvenile_layer_biomass" &
    most_common_depth$year == current_year, ]

  juvenile_common_depths <- Hmisc::wtd.quantile(juvenile_common_depths$depth,
    weights = juvenile_common_depths$layer_biomass,
    probs = c(0.125, 0.875)
  )

  # calculate the middle 50%  off bottom for adults and juveniles as well
  most_common_height_off_bot <- bottom_referenced_summary %>%
    group_by(year, height, size_class) %>%
    # sum biomass/numbers in each layer/size class
    summarize(
      layer_biomass = sum(BIOMASS),
      layer_nums = sum(NUMBERS)
    ) %>%
    # to be safe, arrange by depth
    arrange(height)

  # and pull out the adult/juvenile ranges
  adult_common_height_off_bot <- most_common_height_off_bot[most_common_height_off_bot$size_class == "adult_layer_biomass" &
    most_common_height_off_bot$year == current_year, ]

  adult_common_height_off_bot <- Hmisc::wtd.quantile(adult_common_height_off_bot$height,
    weights = adult_common_height_off_bot$layer_biomass,
    probs = c(0.125, 0.875)
  )

  juv_common_height_off_bot <- most_common_height_off_bot[most_common_height_off_bot$size_class == "juvenile_layer_biomass" &
    most_common_height_off_bot$year == current_year, ]

  juv_common_height_off_bot <- Hmisc::wtd.quantile(juv_common_height_off_bot$height,
    weights = juv_common_height_off_bot$layer_biomass,
    probs = c(0.125, 0.875, 0.95)
  )


  # how much biomass was in the bottom 10m vs the rest of the water column?
  bot_10m_summary <- bottom_referenced_summary %>%
    mutate(bottom_10 = ifelse(height <= 10, "bottom_10", "off_bottom_10")) %>%
    # sum biomass/numbers in each layer/size class
    group_by(year, size_class, bottom_10) %>%
    summarize(
      layer_biomass = sum(BIOMASS),
      layer_nums = sum(NUMBERS)
    ) %>%
    mutate(perc_biomass = layer_biomass / sum(layer_biomass) * 100)

  # how much biomass was in the bottom 50m vs the rest of the water column?
  bot_50m_summary <- bottom_referenced_summary %>%
    mutate(bottom_50 = ifelse(height <= 50, "bottom_50", "off_bottom_50")) %>%
    # sum biomass/numbers in each layer/size class
    group_by(year, size_class, bottom_50) %>%
    summarize(
      layer_biomass = sum(BIOMASS),
      layer_nums = sum(NUMBERS)
    ) %>%
    mutate(perc_biomass = layer_biomass / sum(layer_biomass) * 100)

  # pull out a few values for the text
  adult_within_10_current_year <- bot_10m_summary$perc_biomass[bot_10m_summary$year == current_year &
    bot_10m_summary$size_class == "adult_layer_biomass" &
    bot_10m_summary$bottom_10 == "bottom_10"]

  adult_within_50_current_year <- bot_50m_summary$perc_biomass[bot_50m_summary$year == current_year &
    bot_50m_summary$size_class == "adult_layer_biomass" &
    bot_50m_summary$bottom_50 == "bottom_50"]


  # compare to last 4 years- how did the mean weighted pollock depth from surface compare?
  region_only_surveys <- unique(vertical_dist_surf_ref_biomass_nums_by_length$year[vertical_dist_surf_ref_biomass_nums_by_length$region == region_id])
  
  last_4_years <- region_only_surveys[(length(region_only_surveys) - 4):(length(region_only_surveys) - 1)]

  # compare to last year
  compare_mwd <- function(comparison_year) {
    # compare the current survey to a previous survey- for surface-referenced adults
    comp_value <- mwd_surf_ref$mwd[mwd_surf_ref$year == current_year & mwd_surf_ref$size_class == "adult_layer_biomass"] -
      mwd_surf_ref$mwd[mwd_surf_ref$year == comparison_year & mwd_surf_ref$size_class == "adult_layer_biomass"]

    # return a dataframe with the comparison year, and the comparison
    return(data.frame(comparison_year, comp_value))
  }

  # get the previous suvey comparisons
  last_4_comps <- map_dfr(last_4_years, compare_mwd)

  # note that positive values imply deeper than previous comparison, negative shallower! We use this to build a comparison sentence
  last_4_comps$current_survey_comp <- ifelse(last_4_comps$comp_value > 0, "deeper", "shallower")

  # build a statement describing how things compare to the last 4 years
  previous_4_years_statement <- ifelse(all(last_4_comps$current_survey_comp == "deeper"),
    "deeper",
    ifelse(all(last_4_comps$current_survey_comp == "shallower"),
      "shallower",
      paste0(
        "deeper than ", length(last_4_comps$current_survey_comp[last_4_comps$current_survey_comp == "deeper"]),
        " out of 4 of the last survey"
      )
    )
  )
}

# if there's no bottom-ref dataset, just add a note and set some initial values to dummy values in the text
if (is.null(vertical_dist_bot_ref_biomass_nums_by_length)) {
  depth_distribution_paragraph <- "**Once you run a bottom-referenced dataset, a description of the vertical distribution will show up here.**"
  
  adult_common_depths <- c()
  juvenile_common_depths <- c()
  adult_common_height_off_bot <-c()
  juv_common_height_off_bot <- c()
  last_4_comps <- c()
  previous_4_years_statement <- c()
  adult_within_10_current_year <-0
  adult_within_50_current_year <- 0
  
}

```


Adult pollock (defined as > 30 cm FL) were detected throughout the Strait, with the largest aggregations concentrated in the center of the sea valley south of Cape Igvak (Fig. \@ref(fig:shelikofsticks)). Compared to previous years adult pollock were notably less abundant along the Alaska Peninsula side of the Strait between Cape Nukshak and Cape Kekurnoi where large numbers of pre-spawning fish have been observed during most previous Shelikof surveys. Juvenile pollock (≤ 30 cm FL and largely comprised of age-2 fish from `r (last_year-1)` year class)—typically found in large midwater aggregations shallower than but in proximity to adult aggregations in the middle portion of the Strait in prior surveys—were observed near the ends of transects in the southern portion of the Strait distinctly separated from adult aggregations. The center of gravity for pollock biomass shifted `r round(abs(surv_year_COG_eastings - last_year_COG_eastings), digits=1)` km to the `r ifelse((surv_year_COG_eastings - last_year_COG_eastings)>0, "east", "west")` and `r round(abs(surv_year_COG_northings - last_year_COG_northings), digits=1)` km to the `r ifelse((surv_year_COG_northings - last_year_COG_northings)>0, "north", "south")` from the `r last_year` distribution, continuing a more pronounced shift of `r round(abs(surv_year_COG_eastings - historical_COG_eastings), digits=1)` km to the `r ifelse((surv_year_COG_eastings - historical_COG_eastings)>0, "east", "west")` and `r round(abs(surv_year_COG_northings - historical_COG_northings), digits=1)` km to the `r ifelse((surv_year_COG_northings - historical_COG_northings)>0, "north", "south")` from the historical mean center of gravity between 2008 and `r last_year` (Fig. \@ref(fig:pollockdistribution)). While similar southwestward shifts have occurred since 2008, such a pronounced contraction of the distribution's mean location, as indicated by the reduced inertia axes, is atypical for the past 15-year period (Fig. \@ref(fig:pollockdistribution)). 

Most adult pollock (comprising `r round(adultfishbiopct,1)`% of total biomass) were detected between depths of `r adult_common_depths[[1]]`–`r adult_common_depths[[2]]` m (Fig. \@ref(fig:shelikofstraitviolins)a). Most juvenile pollock (comprising `r round(juvfishnumpct,1)`% of total abundance) were between depths of `r juvenile_common_depths[[1]]`–`r juvenile_common_depths[[2]]` m (Fig. \@ref(fig:shelikofstraitviolins)b). The 'bottom-referenced' analysis indicated that adult pollock were primarily observed within `r adult_common_height_off_bot[[2]]` m of the seafloor with most juveniles found within `r juv_common_height_off_bot[[2]]` m and ranging up to `r juv_common_height_off_bot[[3]]` m (includes 95% of the biomass) off the seafloor (Fig. \@ref(fig:shelikofstraitviolins)c, d). Adult pollock depth distributions in `r current_year` were `r  last_4_comps$current_survey_comp[last_4_comps$comparison_year == last_year]` than those in `r last_year` and `r previous_4_years_statement` than in the prior 4 years (Fig. \@ref(fig:shelikofstraitviolins)a, c), with about `r print_n_decimal(adult_within_10_current_year, 0)`% of the biomass observed within 10m of the seafloor, and `r  print_n_decimal(adult_within_50_current_year, 0)`% percent of biomass within 50 m of the seafloor (Fig. \@ref(fig:shelikofstraitviolins)c).

A total of `r print_n_decimal(rawnum/1e6 , 1) ` million pollock weighing `r print_n_decimal(rawbio/1000, 1)` t were estimated to be in Shelikof Strait at the time of the survey (Tables \@ref(tab:shelikofeva), \@ref(tab:shelikofnumlength)). The `r current_year` biomass `r ifelse(biomass_change_from_last_year > 0, 'increased', 'decreased')` `r print_n_decimal(abs(biomass_change_from_last_year), 1)`% from that observed in `r last_year` (`r print_n_decimal(last_year_vals$biomass_kg/1000, 0)` t) and was `r round(pctofhistoric, digits = 1)`% of the historical mean of `r print_n_decimal(meanHistBiomass, 1)` thousand tons (Table \@ref(tab:shelikofeva), Fig. \@ref(fig:shelikofstraitbiocomps)). The `r current_year` survey biomass estimate is the lowest since 2009 (Fig. \@ref(fig:shelikofstraitbiocomps)). The relative estimation error of the `r current_year` biomass estimate based on the 1-D geostatistical analysis was `r eva_shelikof_perc`% (Table \@ref(tab:shelikofeva)).

Adult pollock with modal lengths of ~48 cm were most abundant by weight (Table \@ref(tab:shelikofbiolength), Fig. \@ref(fig:shelikofbionumslength)), and primarily composed of ages 5, and 11 fish from the 2018, and 2012 year classes that accounted for `r round(yr2018fishbiopct, digits=1)`% and `r round(yr2012fishbiopct, digits=1)`% of total biomass, respectively (Table \@ref(tab:shelikofbioage), Fig. \@ref(fig:shelikofbionumsages)). Age-3 pollock (modal length ~35 cm FL, `r (last_year-1)` year class) contributed minimally in terms of numbers (`r round(age2numpct, digits=1)`%) and only accounted for `r round(age3biopct, digits=1)`% of the biomass (Tables \@ref(tab:shelikofnumlength) - \@ref(tab:shelikofnumage), Figs. \@ref(fig:shelikofbionumslength), \@ref(fig:shelikofbionumsages)). This is a notable decline in numbers and biomass of the `r (last_year-1)` year class from the `r last_year` survey when they were particularly numerous as age-2s (Tables \@ref(tab:shelikofbioage), \@ref(tab:shelikofnumage), Figs. \@ref(fig:shelikofridgelineslength), \@ref(fig:shelikofridgelinesages)). In addition, very few age-1 pollock (< 17 cm FL, `r last_year` year class) were observed in `r current_year`, accounting for only `r round(age1numpct, digits=1)`% of the numbers and $\le$ `r round(age1biopct, digits=1)`% of the biomass of all pollock observed in Shelikof Strait (Figs. \@ref(fig:shelikofbionumslength), \@ref(fig:shelikofbionumsages)). Compared to the same age groups from previous surveys (2008–`r last_year`), pollock that were age 12 and older were shorter and lighter (Fig. \@ref(fig:shelikofstraitlwage)).   

*Effects of Net Selectivity Corrections and Estimated Strength of `r last_year` Year Class*

```{r, shelikof_selectivity_paragraph, echo = FALSE, message=FALSE, warning=FALSE}
# Current year non-selectivity based estimate- numbers of age 1 fish for McKelvey index and comparisons; we can get this from our comparisons dataset- it has pollock summarized by length
NoSelect <- analysis_comparisons %>%
  filter(region == region_id) %>%
  # get the non-selectivity dataset for the region; this relies on having that as a comparison dataset and assumes the first comparison
  # is non-selectivity
  filter(DATA_SET_ID == comp_data_sets_shelikof[1] & ANALYSIS_ID == comp_analyses_shelikof[1] & region == region_id)

pctofprimarybio <- ((sum(NoSelect$BIOMASS) - rawbio) / rawbio) * 100
pctofprimarynum <- ((sum(NoSelect$NUMBERS) - rawnum) / rawnum) * 100

age1fishnoselect <- NoSelect %>%
  filter(LENGTH <= 16)
```

The results presented here account for escapement of organisms from the net based on the prior LFS1421 selectivity values obtained from catches in the codend and recapture nets from the 2020 and 2021 winter Shelikof Strait surveys. These results also reflect adjustments to the backscatter allotted to the target species by removing backscatter that would be attributable to other species based on the catch composition of the nearest haul and their estimated scattering properties. While this reflects analysis procedures in the winter Shelikof Strait survey time series since 2019, analyses in previous years have not fully taken these factors into account. Thus an alternate analysis was conducted that would more closely approximate analyses in prior years for comparison, and resulting abundances are presented (Fig. \@ref(fig:shelikofanalysiscomps)). Specifically, an alternate analysis was conducted that did not include the effect of net selectivity (referred to as the 'no-selectivity' analysis below). This is similar to the comparison performed in 2021 to evaluate the effects of net selectivity corrections [@Honkalehto_etal_InPrep]. 

The no-selectivity analysis for `r current_year` generated an overall `r ifelse(pctofprimarynum <0, 'decrease', 'increase')` of `r print_n_decimal(abs(pctofprimarynum), 1)`% by numbers (to `r print_n_decimal(sum(NoSelect$NUMBERS)/1e6, 0)` million) and an `r ifelse(pctofprimarybio <0, 'decrease', 'increase')` of `r print_n_decimal(abs(pctofprimarybio), 1)`% by weight (to `r print_n_decimal(sum(NoSelect$BIOMASS, na.rm = TRUE)/1000,0)` t) for pollock in the Shelikof Strait area compared to the primary analysis (i.e. "selectivity corrected", Fig. \@ref(fig:shelikofanalysiscomps)). The negligible effect of net selectivity corrections on the `r current_year` primary analysis estimates is expected given the spatial separation between juvenile (≤ 30 cm FL) and adult (> 30 cm FL) pollock (Fig. \@ref(fig:shelikofsticks)), which resulted in relatively low mixing of juveniles (i.e. low retention in codend) with adults (i.e. high retention) in trawl catches [see Appendix IV in Honkalehto et al. -@Honkalehto_etal_InPrep].

Historic population trends in Shelikof Strait as observed by winter pre-spawning AT surveys track the strong year classes well through time starting from relatively small sizes and young ages (Figs. \@ref(fig:shelikofridgelineslength), \@ref(fig:shelikofridgelinesages)). @McKelvey_1996 showed that there was a strong relationship between the estimated number of age-1 pollock from the winter Shelikof Strait survey and year-class strength for GOA pollock. The McKelvey index is based on data that did not include a correction for escapement of age-1 pollock, therefore, the `r current_year` non-selectivity based estimate (Analysis `r comp_analyses_shelikof[1]`) was used to classify the strength of the `r last_year` year class (age-1 pollock observed in `r current_year`) in the context of the McKelvey index. This estimate was `r print_n_decimal(sum(age1fishnoselect$NUMBERS)/1e6, 1)` million age-1 pollock, which is considered a low or weak year class based on the McKelvey index. 

